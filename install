#!/bin/bash
#
# Speech-to-Text Push-to-Talk Setup
# Installs dependencies and configures the system
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="${HOME}/.local/share/kikiriki"

echo "=========================================="
echo "  Kikiriki Speech-to-Text Push-to-Talk Setup"
echo "=========================================="
echo

# Check if running on Ubuntu/Debian
if ! command -v apt &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: This script is designed for Ubuntu/Debian systems"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check if running on X server
echo "Checking for X server..."
if [[ "${XDG_SESSION_TYPE:-}" != "x11" ]]; then
    if [[ -n "${XDG_SESSION_TYPE:-}" ]]; then
        echo "‚ùå Error: Not running on X11 (detected: ${XDG_SESSION_TYPE})"
    elif [[ -z "${DISPLAY:-}" ]]; then
        echo "‚ùå Error: Not running on X server (no X11 session detected)"
    else
        echo "‚ö†Ô∏è  Warning: Cannot determine session type, but DISPLAY is set"
        echo "   Kikiriki requires X11 to function properly"
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    if [[ "${XDG_SESSION_TYPE:-}" == "wayland" ]]; then
        echo "   Kikiriki requires X11 and does not support Wayland"
        exit 1
    elif [[ -n "${XDG_SESSION_TYPE:-}" && "${XDG_SESSION_TYPE}" != "x11" ]]; then
        echo "   Kikiriki requires X11 to function properly"
        exit 1
    fi
else
    echo "‚úÖ X11 session detected"
fi
echo

# Check for whisper.cpp installation
echo "Checking for whisper.cpp..."
WHISPER_CPP_DIR="${HOME}/.local/share/whisper.cpp"
if [[ ! -f "${WHISPER_CPP_DIR}/build/bin/whisper-cli" ]]; then
    echo "‚ö†Ô∏è  Warning: whisper-cli not found at ${WHISPER_CPP_DIR}/build/bin/whisper-cli"
    echo "   Make sure whisper.cpp is built and available"
    echo "   The script will continue, but you'll need to edit the paths in kikiriki"
fi

if [[ ! -f "${WHISPER_CPP_DIR}/models/ggml-base.en.bin" ]]; then
    echo "‚ö†Ô∏è  Warning: Whisper model not found at ${WHISPER_CPP_DIR}/models/ggml-base.en.bin"
    echo "   You may need to download a model first"
fi

echo
echo "Installing system dependencies..."

# Check which packages need to be installed
PACKAGES_TO_INSTALL=()
for pkg in xbindkeys alsa-utils pulseaudio-utils x11-xserver-utils xdotool xclip libnotify-bin; do
    if ! dpkg-query -W -f='${Status}' "$pkg" 2>/dev/null | grep -q "install ok installed"; then
        PACKAGES_TO_INSTALL+=("$pkg")
    fi
done

if [[ ${#PACKAGES_TO_INSTALL[@]} -gt 0 ]]; then
    echo "Will install: ${PACKAGES_TO_INSTALL[*]}"
    sudo apt update
    sudo apt install -y "${PACKAGES_TO_INSTALL[@]}"
    echo "‚úÖ Dependencies installed"
else
    echo "‚úÖ All dependencies already installed"
fi

# Create installation directory
echo
echo "Creating installation directory..."
mkdir -p "${INSTALL_DIR}/sounds"
echo "‚úÖ Created: ${INSTALL_DIR}"

# Copy runtime files
echo
echo "Copying files to installation directory..."
cp "${SCRIPT_DIR}/kikiriki" "${INSTALL_DIR}/"
cp "${SCRIPT_DIR}/kikiriki-bind-keys" "${INSTALL_DIR}/"
cp "${SCRIPT_DIR}/kikiriki-unbind-keys" "${INSTALL_DIR}/"
cp "${SCRIPT_DIR}/keyhold-handler" "${INSTALL_DIR}/"
cp "${SCRIPT_DIR}/uninstall" "${INSTALL_DIR}/"
cp "${SCRIPT_DIR}/sounds/message.oga" "${INSTALL_DIR}/sounds/"
cp "${SCRIPT_DIR}/sounds/complete.oga" "${INSTALL_DIR}/sounds/"
echo "‚úÖ Files copied"

# Make scripts executable
echo
echo "Making scripts executable..."
chmod +x "${INSTALL_DIR}/kikiriki"
chmod +x "${INSTALL_DIR}/kikiriki-bind-keys"
chmod +x "${INSTALL_DIR}/kikiriki-unbind-keys"
chmod +x "${INSTALL_DIR}/keyhold-handler"
chmod +x "${INSTALL_DIR}/uninstall"
echo "‚úÖ Scripts are executable"

# Setup xbindkeys configuration
echo
echo "Generating xbindkeys configuration..."

XBINDKEYS_CONFIG="${INSTALL_DIR}/kikiriki-xbindkeys.conf"
XBINDKEYS_TEMPLATE="${SCRIPT_DIR}/kikiriki-xbindkeys.conf.template"

# Check if template exists
if [[ ! -f "$XBINDKEYS_TEMPLATE" ]]; then
    echo "‚ùå Error: xbindkeys template not found: $XBINDKEYS_TEMPLATE"
    exit 1
fi

# Generate kikiriki-xbindkeys.conf from template
sed "s|KIKIRIKI_INSTALL_DIR|${INSTALL_DIR}|g" "$XBINDKEYS_TEMPLATE" > "$XBINDKEYS_CONFIG"
echo "‚úÖ Generated xbindkeys configuration: $XBINDKEYS_CONFIG"

# Setup systemd user service
echo
echo "Setting up systemd user service..."

SYSTEMD_USER_DIR="${HOME}/.config/systemd/user"
SERVICE_FILE="${SYSTEMD_USER_DIR}/kikiriki.service"
SERVICE_TEMPLATE="${SCRIPT_DIR}/kikiriki.service"

mkdir -p "$SYSTEMD_USER_DIR"

# Check if service template exists
if [[ ! -f "$SERVICE_TEMPLATE" ]]; then
    echo "‚ùå Error: Service template not found: $SERVICE_TEMPLATE"
    exit 1
fi

# Copy and customize the service file
sed "s|KIKIRIKI_INSTALL_DIR|${INSTALL_DIR}|g" "$SERVICE_TEMPLATE" > "$SERVICE_FILE"

# Reload systemd user daemon
systemctl --user daemon-reload

# Enable the service to start on login
systemctl --user enable kikiriki.service
echo "‚úÖ Created and enabled systemd user service"

# Optionally start the service now
echo
read -p "Start the service now? (Y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    systemctl --user start kikiriki.service
    sleep 1
    echo
    systemctl --user status kikiriki.service --no-pager
fi

echo
echo "=========================================="
echo "  ‚úÖ Setup Complete!"
echo "=========================================="
echo
echo "üìÅ Installation directory: ${INSTALL_DIR}"
echo "‚öôÔ∏è  Configuration file: ${INSTALL_DIR}/kikiriki-xbindkeys.conf"
echo
echo "üéØ Default hotkey: Ctrl+Space"
echo "   - Press and hold to record"
echo "   - Release to transcribe"
echo
echo "To customize settings, edit:"
echo "  ${INSTALL_DIR}/kikiriki"
echo
echo "To change the hotkey, edit:"
echo "  ${INSTALL_DIR}/kikiriki-xbindkeys.conf"
echo "  Then run: systemctl --user restart kikiriki.service"
echo
echo "Service Management:"
echo "  Start:   systemctl --user start kikiriki.service"
echo "  Stop:    systemctl --user stop kikiriki.service"
echo "  Restart: systemctl --user restart kikiriki.service"
echo "  Status:  systemctl --user status kikiriki.service"
echo "  Logs:    journalctl --user -u kikiriki.service -f"
echo
echo "Auto-start on login:"
echo "  Enable:  systemctl --user enable kikiriki.service"
echo "  Disable: systemctl --user disable kikiriki.service"
echo
echo "To uninstall:"
echo "  ${INSTALL_DIR}/uninstall"
echo
echo "To test the script manually:"
echo "  ${INSTALL_DIR}/kikiriki start"
echo "  # speak something"
echo "  ${INSTALL_DIR}/kikiriki stop"
echo
