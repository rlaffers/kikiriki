#!/bin/bash
#
# Speech-to-Text Push-to-Talk
# Usage: kikiriki {start|stop}
#

set -euo pipefail

# Verbose mode (controlled by -v flag)
VERBOSE_MODE=false

# Default Configuration
# These values can be overridden in ~/.config/kikiriki/kikiriki.conf
WHISPER_MODEL="${HOME}/.local/share/whisper.cpp/models/ggml-base.en.bin"
WHISPER_BIN="${HOME}/.local/share/whisper.cpp/build/bin/whisper-cli"
WHISPER_THREADS=8
WHISPER_LANG="en"
AUDIO_DEVICE="default"
ENABLE_NOTIFICATIONS=true
ENABLE_SOUNDS=true
AUTO_PASTE=true

# Load user configuration if it exists
CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/kikiriki/kikiriki.conf"
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
fi

# Audio settings (not configurable via config file)
SAMPLE_RATE=16000
AUDIO_FORMAT="S16_LE"
AUDIO_CHANNELS=1

# Feedback sounds
SOUND_START="${BASH_SOURCE%/*}/sounds/message.oga"
SOUND_STOP="${BASH_SOURCE%/*}/sounds/complete.oga"

# Output
TEMP_DIR="/tmp"

# Runtime files
STATE_DIR="${HOME}/.local/state/kikiriki"
LOCK_FILE="${STATE_DIR}/recording.lock"
TEMP_AUDIO="${TEMP_DIR}/kikiriki-recording-$$.wav"

# Create state directory
mkdir -p "$STATE_DIR"

# Functions
play_sound() {
    [[ "$ENABLE_SOUNDS" == "true" ]] && [[ -f "$1" ]] && paplay "$1" &>/dev/null &
}

notify() {
    local critical="${2:-false}"
    if [[ "$ENABLE_NOTIFICATIONS" == "true" ]]; then
        if [[ "$VERBOSE_MODE" == "true" ]] || [[ "$critical" == "true" ]]; then
            notify-send -t 2000 "$1" ${3:+$3} &>/dev/null || true
        fi
    fi
}

start_recording() {
    # Prevent multiple recordings
    if [[ -f "$LOCK_FILE" ]]; then
        exit 0
    fi
    
    # Create temp file with unique name
    TEMP_AUDIO="${TEMP_DIR}/kikiriki-recording-$RANDOM-$$.wav"
    echo "$TEMP_AUDIO" > "$LOCK_FILE"
    
    if [[ "$VERBOSE_MODE" == "true" ]]; then
      echo "Recording to temporary file: $TEMP_AUDIO"
    fi

    # Start recording
    arecord -f "$AUDIO_FORMAT" -r "$SAMPLE_RATE" -c "$AUDIO_CHANNELS" \
            -D "$AUDIO_DEVICE" "$TEMP_AUDIO" &>/dev/null &
    
    if [[ "$VERBOSE_MODE" == "true" ]]; then
      echo "File recording started with PID: $!"
    fi

    # Append PID to lock file
    echo "$!" >> "$LOCK_FILE"
    
    play_sound "$SOUND_START"
    notify "üé§ Recording..." false "-u low"
}

stop_recording() {
    # Check if recording
    if [[ ! -f "$LOCK_FILE" ]]; then
        exit 0
    fi
    
    # Read temp audio path and PID from lock file
    TEMP_AUDIO=$(head -n 1 "$LOCK_FILE" 2>/dev/null || echo "")
    RECORDING_PID=$(tail -n 1 "$LOCK_FILE" 2>/dev/null || echo "")
    rm -f "$LOCK_FILE"
    
    if [[ "$VERBOSE_MODE" == "true" ]]; then
      echo "Stopping recording with PID: $RECORDING_PID"
      echo "Temporary audio file: $TEMP_AUDIO"
    fi

    # Stop recording
    if [[ -n "$RECORDING_PID" ]] && kill -0 "$RECORDING_PID" 2>/dev/null; then
        kill -INT "$RECORDING_PID" 2>/dev/null || true
        wait "$RECORDING_PID" 2>/dev/null || true
    fi
    
    play_sound "$SOUND_STOP"

    # re-mux the recording to fix the invalid duration in the WAV header
    TEMP_AUDIO_FIXED="${TEMP_AUDIO}.fixed.wav"
    ffmpeg -y -i "$TEMP_AUDIO" -ar "$SAMPLE_RATE" -ac "$AUDIO_CHANNELS" -c:a pcm_s16le "${TEMP_AUDIO_FIXED}" &>/dev/null

    if [[ "$VERBOSE_MODE" == "true" ]]; then
      echo " Starting transcription..."
    fi

    notify "‚öôÔ∏è Processing..." false "-u low"
    
    # Check audio file size (needs at least 1KB)
    if [[ ! -f "$TEMP_AUDIO_FIXED" ]] || [[ $(stat -c%s "$TEMP_AUDIO_FIXED" 2>/dev/null || echo 0) -lt 1000 ]]; then
        notify "‚ùå Recording too short" true "-u critical"
        rm -f "$TEMP_AUDIO"
        rm -f "$TEMP_AUDIO_FIXED"
        exit 0
    fi
    
    # Transcribe
    start_time=$(date +%s%N)
    if output=$("$WHISPER_BIN" -m "$WHISPER_MODEL" -f "$TEMP_AUDIO_FIXED" \
                -t "$WHISPER_THREADS" -l "$WHISPER_LANG" \
                --no-timestamps --output-txt --output-file - 2>/dev/null); then
        end_time=$(date +%s%N)
        elapsed_ms=$(( (end_time - start_time) / 1000000 ))
        
        # Format elapsed time
        if [[ $elapsed_ms -ge 10000 ]]; then
            # Format as seconds with 1 decimal place (e.g., "12.3s")
            elapsed_sec=$(( elapsed_ms / 100 ))
            elapsed_display=$(printf "%d.%ds" $((elapsed_sec / 10)) $((elapsed_sec % 10)))
        else
            # Format as milliseconds (e.g., "1234ms")
            elapsed_display="${elapsed_ms}ms"
        fi

        if [[ "$VERBOSE_MODE" == "true" ]]; then
          echo "Transcription completed in ${elapsed_display}"
        fi
        
        # Clean output - remove whisper metadata and empty lines
        output=$(echo "$output" | grep -v "^whisper_" | grep -v "^system_info" | grep -v "^main:" | sed '/^$/d' | tr '\n' ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        
        if [[ -n "$output" ]]; then
            if [[ "$AUTO_PASTE" == "true" ]]; then
                sleep 0.1
                echo -n "$output" | xdotool type --clearmodifiers --file -
                notify "‚úÖ Inserted text (${elapsed_display})" false "-u normal"
            else
                echo -n "$output" | xclip -selection clipboard 2>/dev/null
                notify "üìã Copied to clipboard (${elapsed_display})" false "-u normal"
            fi
        else
            notify "‚ùå No speech detected" true "-u critical"
        fi
    else
        if [[ "$VERBOSE_MODE" == "true" ]]; then
          echo "Transcription failed"
        fi
        notify "‚ùå Transcription failed" true "-u critical"
    fi
    
    # Cleanup
    rm -f "$TEMP_AUDIO"
    rm -f "$TEMP_AUDIO_FIXED"
}

# Main
# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            echo -e "Usage: $0 [-v] {start|stop}\n"
            echo "  -v    Verbose mode (show all notifications)"
            echo "  -h    Show this help message"
            exit 0
            ;;
        -v)
            VERBOSE_MODE=true
            shift
            ;;
        start|stop)
            ACTION="$1"
            shift
            ;;
        *)
            echo -e "Usage: $0 [-v] {start|stop}\n"
            echo "  -v    Verbose mode (show all notifications)"
            echo "  -h    Show this help message"
            exit 1
            ;;
    esac
done

# Execute action
case "${ACTION:-}" in
    start)
        start_recording
        ;;
    stop)
        stop_recording
        ;;
    *)
        echo "Usage: $0 [-v] {start|stop}"
        echo "  -v    Verbose mode (show all notifications)"
        echo "  -h    Show this help message"
        exit 1
        ;;
esac
