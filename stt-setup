#!/bin/bash
#
# Speech-to-Text Push-to-Talk Setup
# Installs dependencies and configures the system
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "=========================================="
echo "  Speech-to-Text Push-to-Talk Setup"
echo "=========================================="
echo

# Check if running on Ubuntu/Debian
if ! command -v apt &> /dev/null; then
    echo "âš ï¸  Warning: This script is designed for Ubuntu/Debian systems"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for whisper.cpp installation
echo "Checking for whisper.cpp..."
if [[ ! -f "${HOME}/whisper.cpp/build/bin/whisper-cli" ]]; then
    echo "âš ï¸  Warning: whisper-cli not found at ${HOME}/whisper.cpp/build/bin/whisper-cli"
    echo "   Make sure whisper.cpp is built and available"
    echo "   The script will continue, but you'll need to edit the paths in kikiriki"
fi

if [[ ! -f "${HOME}/whisper.cpp/models/ggml-base.en.bin" ]]; then
    echo "âš ï¸  Warning: Whisper model not found at ${HOME}/whisper.cpp/models/ggml-base.en.bin"
    echo "   You may need to download a model first"
fi

echo
echo "Installing system dependencies..."

# Check which packages need to be installed
PACKAGES_TO_INSTALL=()
for pkg in xbindkeys alsa-utils pulseaudio-utils x11-xserver-utils xdotool xclip libnotify-bin; do
    if ! dpkg -l | grep -q "^ii  $pkg "; then
        PACKAGES_TO_INSTALL+=("$pkg")
    fi
done

if [[ ${#PACKAGES_TO_INSTALL[@]} -gt 0 ]]; then
    echo "Will install: ${PACKAGES_TO_INSTALL[*]}"
    sudo apt update
    sudo apt install -y "${PACKAGES_TO_INSTALL[@]}"
    echo "âœ… Dependencies installed"
else
    echo "âœ… All dependencies already installed"
fi

# Make scripts executable
echo
echo "Making scripts executable..."
chmod +x "${SCRIPT_DIR}/kikiriki"
chmod +x "${SCRIPT_DIR}/stt-start"
chmod +x "${SCRIPT_DIR}/stt-stop"
echo "âœ… Scripts are executable"

# Setup xbindkeys configuration (local to this directory)
echo
echo "Setting up xbindkeys configuration..."

XBINDKEYS_CONFIG="${SCRIPT_DIR}/xbindkeysrc"
echo "âœ… Using local configuration: $XBINDKEYS_CONFIG"

# Setup auto-start
echo
echo "Setting up auto-start..."

AUTOSTART_DIR="${HOME}/.config/autostart"
AUTOSTART_FILE="${AUTOSTART_DIR}/kikiriki.desktop"

mkdir -p "$AUTOSTART_DIR"

cat > "$AUTOSTART_FILE" << EOF
[Desktop Entry]
Type=Application
Name=Speech-to-Text Push-to-Talk
Exec=${SCRIPT_DIR}/stt-start
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Comment=Speech-to-Text Push-to-Talk using xbindkeys
EOF
echo "âœ… Created autostart entry"

echo
echo "=========================================="
echo "  âœ… Setup Complete!"
echo "=========================================="
echo
echo "ðŸ“ Installation directory: $SCRIPT_DIR"
echo "âš™ï¸  Configuration file: $XBINDKEYS_CONFIG"
echo
echo "ðŸŽ¯ Default hotkey: Ctrl+Space"
echo "   - Press and hold to record"
echo "   - Release to transcribe"
echo
echo "To customize settings, edit:"
echo "  ${SCRIPT_DIR}/kikiriki"
echo
echo "To change the hotkey, edit:"
echo "  ${SCRIPT_DIR}/xbindkeysrc"
echo "  Then run: ${SCRIPT_DIR}/stt-stop && ${SCRIPT_DIR}/stt-start"
echo
echo "To start now:"
echo "  ${SCRIPT_DIR}/stt-start"
echo
echo "To stop:"
echo "  ${SCRIPT_DIR}/stt-stop"
echo
echo "To test the script manually:"
echo "  ${SCRIPT_DIR}/kikiriki start"
echo "  # speak something"
echo "  ${SCRIPT_DIR}/kikiriki stop"
echo
