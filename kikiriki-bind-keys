#!/bin/bash
#
# Start Speech-to-Text Push-to-Talk
# Uses the kikiriki-xbindkeys.conf configuration from ~/.config/kikiriki/
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/kikiriki"
CONFIG_FILE="${CONFIG_DIR}/kikiriki-xbindkeys.conf"
PIDFILE="/run/user/${UID}/kikiriki-xbindkeys.pid"

# Check if xbindkeys is already running with our config
if pgrep -f "xbindkeys.*${CONFIG_FILE}" >/dev/null; then
    echo "‚úÖ Kikiriki Speech-to-Text Push-to-Talk is already running"
    exit 0
fi

# Check if config file exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "‚ùå Error: Configuration file not found: $CONFIG_FILE"
    exit 1
fi

# Ensure runtime directory exists
mkdir -p "/run/user/${UID}"

# Start xbindkeys with our config
echo "üöÄ Starting Kikiriki Speech-to-Text Push-to-Talk..."
echo "üìÅ Config: $CONFIG_FILE"
echo "üéØ Hotkey: Ctrl+Space (hold to record, release to transcribe)"
echo

xbindkeys -f "$CONFIG_FILE"

# Wait for xbindkeys to fork and settle
sleep 0.5

# Capture the PID of the xbindkeys process
XBINDKEYS_PID=$(pgrep -f "xbindkeys.*${CONFIG_FILE}" || echo "")

if [[ -n "$XBINDKEYS_PID" ]]; then
    echo "$XBINDKEYS_PID" > "$PIDFILE"
    echo "‚úÖ Started successfully! (PID: $XBINDKEYS_PID)"
    echo
    echo "To stop: ${SCRIPT_DIR}/kikiriki-unbind-keys"
    exit 0
else
    echo "‚ùå Failed to start xbindkeys"
    rm -f "$PIDFILE"
    exit 1
fi
