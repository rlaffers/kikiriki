#!/bin/bash
#
# Speech-to-Text Push-to-Talk Setup
# Installs dependencies and configures the system
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "=========================================="
echo "  Kikiriki Speech-to-Text Push-to-Talk Setup"
echo "=========================================="
echo

# Check if running on Ubuntu/Debian
if ! command -v apt &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: This script is designed for Ubuntu/Debian systems"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for whisper.cpp installation
echo "Checking for whisper.cpp..."
if [[ ! -f "${HOME}/whisper.cpp/build/bin/whisper-cli" ]]; then
    echo "‚ö†Ô∏è  Warning: whisper-cli not found at ${HOME}/whisper.cpp/build/bin/whisper-cli"
    echo "   Make sure whisper.cpp is built and available"
    echo "   The script will continue, but you'll need to edit the paths in kikiriki"
fi

if [[ ! -f "${HOME}/whisper.cpp/models/ggml-base.en.bin" ]]; then
    echo "‚ö†Ô∏è  Warning: Whisper model not found at ${HOME}/whisper.cpp/models/ggml-base.en.bin"
    echo "   You may need to download a model first"
fi

echo
echo "Installing system dependencies..."

# Check which packages need to be installed
PACKAGES_TO_INSTALL=()
for pkg in xbindkeys alsa-utils pulseaudio-utils x11-xserver-utils xdotool xclip libnotify-bin; do
    if ! dpkg-query -W -f='${Status}' "$pkg" 2>/dev/null | grep -q "install ok installed"; then
      echo "‚ûï Will install missing package: $pkg"
        PACKAGES_TO_INSTALL+=("$pkg")
    fi
done

if [[ ${#PACKAGES_TO_INSTALL[@]} -gt 0 ]]; then
    echo "Will install: ${PACKAGES_TO_INSTALL[*]}"
    sudo apt update
    sudo apt install -y "${PACKAGES_TO_INSTALL[@]}"
    echo "‚úÖ Dependencies installed"
else
    echo "‚úÖ All dependencies already installed"
fi

# Make scripts executable
echo
echo "Making scripts executable..."
chmod +x "${SCRIPT_DIR}/kikiriki"
chmod +x "${SCRIPT_DIR}/kikiriki-bind-keys"
chmod +x "${SCRIPT_DIR}/kikiriki-unbind-keys"
chmod +x "${SCRIPT_DIR}/keyhold-handler"
echo "‚úÖ Scripts are executable"

# Setup xbindkeys configuration (local to this directory)
echo
echo "Setting up xbindkeys configuration..."

XBINDKEYS_CONFIG="${SCRIPT_DIR}/kikiriki-xbindkeys.conf"
XBINDKEYS_TEMPLATE="${SCRIPT_DIR}/kikiriki-xbindkeys.conf.template"

# Check if template exists
if [[ ! -f "$XBINDKEYS_TEMPLATE" ]]; then
    echo "‚ùå Error: xbindkeys template not found: $XBINDKEYS_TEMPLATE"
    exit 1
fi

# Generate kikiriki-xbindkeys.conf from template
sed "s|KIKIRIKI_INSTALL_DIR|${SCRIPT_DIR}|g" "$XBINDKEYS_TEMPLATE" > "$XBINDKEYS_CONFIG"
echo "‚úÖ Generated xbindkeys configuration: $XBINDKEYS_CONFIG"

# Setup systemd user service
echo
echo "Setting up systemd user service..."

SYSTEMD_USER_DIR="${HOME}/.config/systemd/user"
SERVICE_FILE="${SYSTEMD_USER_DIR}/kikiriki.service"
SERVICE_TEMPLATE="${SCRIPT_DIR}/kikiriki.service"

mkdir -p "$SYSTEMD_USER_DIR"

# Check if service template exists
if [[ ! -f "$SERVICE_TEMPLATE" ]]; then
    echo "‚ùå Error: Service template not found: $SERVICE_TEMPLATE"
    exit 1
fi

# Copy and customize the service file
sed "s|KIKIRIKI_INSTALL_DIR|${SCRIPT_DIR}|g" "$SERVICE_TEMPLATE" > "$SERVICE_FILE"

# Reload systemd user daemon
systemctl --user daemon-reload

# Enable the service to start on login
systemctl --user enable kikiriki.service
echo "‚úÖ Created and enabled systemd user service"

# Optionally start the service now
echo
read -p "Start the service now? (Y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    systemctl --user start kikiriki.service
    sleep 1
    echo
    systemctl --user status kikiriki.service --no-pager
fi

echo
echo "=========================================="
echo "  ‚úÖ Setup Complete!"
echo "=========================================="
echo
echo "üìÅ Installation directory: $SCRIPT_DIR"
echo "‚öôÔ∏è  Configuration file: $XBINDKEYS_CONFIG"
echo
echo "üéØ Default hotkey: Ctrl+Alt+G"
echo "   - Press and hold to record"
echo "   - Release to transcribe"
echo
echo "To customize settings, edit:"
echo "  ${SCRIPT_DIR}/kikiriki"
echo
echo "To change the hotkey, edit:"
echo "  ${SCRIPT_DIR}/kikiriki-xbindkeys.conf"
echo "  Then run: systemctl --user restart kikiriki.service"
echo
echo "Service Management:"
echo "  Start:   systemctl --user start kikiriki.service"
echo "  Stop:    systemctl --user stop kikiriki.service"
echo "  Restart: systemctl --user restart kikiriki.service"
echo "  Status:  systemctl --user status kikiriki.service"
echo "  Logs:    journalctl --user -u kikiriki.service -f"
echo
echo "Auto-start on login:"
echo "  Enable:  systemctl --user enable kikiriki.service"
echo "  Disable: systemctl --user disable kikiriki.service"
echo
echo "To uninstall:"
echo "  ${SCRIPT_DIR}/uninstall"
echo
echo "To test the script manually:"
echo "  ${SCRIPT_DIR}/kikiriki start"
echo "  # speak something"
echo "  ${SCRIPT_DIR}/kikiriki stop"
echo
