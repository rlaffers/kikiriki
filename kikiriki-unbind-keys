#!/bin/bash
#
# Stop Speech-to-Text Push-to-Talk
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/kikiriki"
CONFIG_FILE="${CONFIG_DIR}/kikiriki-xbindkeys.conf"
PIDFILE="/run/user/${UID}/kikiriki-xbindkeys.pid"

# Kill xbindkeys running with our config
if pgrep -f "xbindkeys.*${CONFIG_FILE}" >/dev/null; then
    pkill -f "xbindkeys.*${CONFIG_FILE}"
    echo "âœ… Kikiriki Speech-to-Text Push-to-Talk stopped"
else
    echo "â„¹ï¸  Kikiriki Speech-to-Text Push-to-Talk is not running"
fi

# Clean up PID file
rm -f "$PIDFILE"

# Clean up any stray recording processes
STATE_DIR="${HOME}/.local/state/kikiriki"
LOCK_FILE="${STATE_DIR}/recording.lock"

if [[ -f "$LOCK_FILE" ]]; then
    RECORDING_PID=$(tail -n 1 "$LOCK_FILE" 2>/dev/null || echo "")
    if [[ -n "$RECORDING_PID" ]] && kill -0 "$RECORDING_PID" 2>/dev/null; then
        kill -INT "$RECORDING_PID" 2>/dev/null || true
        echo "ðŸ§¹ Cleaned up recording process"
    fi
    rm -f "$LOCK_FILE"
fi
